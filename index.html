<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XP Deus II V5 - CONSOLE EXPERT PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        :root {
            --bg-body: #121418;
            --bg-panel: #1b2028;
            --bg-input: #0f1114;
            --accent-gold: #d4af37;
            --accent-blue: #5c8bc0;
            --text-main: #e0e6ed;
            --text-dim: #aab6c6;
            --border-light: #2d333d;
            --success: #66bb6a;
            --warning: #ffa726;
            --danger: #ef5350;
            --info: #29b6f6;
            --fmf: #b388ff;
            --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="light"] {
            --bg-body: #f5f5f5;
            --bg-panel: #ffffff;
            --bg-input: #e8e8e8;
            --text-main: #1a1a1a;
            --text-dim: #555555;
            --border-light: #d0d0d0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-body); color: var(--text-main); line-height: 1.5; min-height: 100vh; font-size: 15px; transition: var(--transition); }

        header { background: linear-gradient(180deg, #1f242d 0%, #121418 100%); padding: 15px; border-bottom: 2px solid var(--accent-gold); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 20px rgba(0,0,0,0.5); flex-wrap: wrap; gap: 10px; }
        [data-theme="light"] header { background: linear-gradient(180deg, #f0f0f0 0%, #e0e0e0 100%); }
        header h1 { color: var(--accent-gold); font-size: 1.4rem; text-transform: uppercase; letter-spacing: 1px; flex: 1; min-width: 200px; }
        header p { color: var(--text-dim); font-size: 0.8rem; }

        .header-right { display: flex; gap: 10px; align-items: center; }
        .theme-toggle { background: var(--bg-panel); border: 1px solid var(--border-light); color: var(--text-main); padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: var(--transition); }
        .theme-toggle:hover { border-color: var(--accent-gold); color: var(--accent-gold); }

        .nav-container { background: var(--bg-panel); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border-light); padding: 0 5px; overflow-x: auto; display: flex; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .nav-btn { background: none; border: none; color: var(--text-dim); padding: 12px 15px; cursor: pointer; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; transition: var(--transition); border-bottom: 3px solid transparent; white-space: nowrap; }
        .nav-btn:hover { color: var(--text-main); background: rgba(255,255,255,0.02); }
        .nav-btn.active { color: var(--accent-gold); border-bottom-color: var(--accent-gold); }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px 60px 15px; }
        .tab-content { display: none; animation: fadeEffect 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeEffect { from {opacity: 0; transform: translateY(5px);} to {opacity: 1; transform: translateY(0);} }

        .card { background: var(--bg-panel); border: 1px solid var(--border-light); border-radius: 8px; padding: 20px; margin-bottom: 20px; transition: var(--transition); }
        .card h2 { color: var(--accent-blue); font-size: 1.2rem; text-transform: uppercase; margin-bottom: 20px; border-left: 3px solid var(--accent-gold); padding-left: 10px; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }

        .badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; margin-right: 5px; margin-bottom: 5px; }
        .badge-recommended { background: rgba(102, 187, 106, 0.2); color: var(--success); border: 1px solid var(--success); }
        .badge-risky { background: rgba(255, 167, 38, 0.2); color: var(--warning); border: 1px solid var(--warning); }
        .badge-optimal { background: rgba(92, 139, 192, 0.2); color: var(--accent-blue); border: 1px solid var(--accent-blue); }

        label { display: block; color: var(--text-dim); margin-bottom: 6px; font-size: 0.8rem; text-transform: uppercase; }
        select, input[type="text"], input[type="number"], textarea { width: 100%; background: var(--bg-input); border: 1px solid var(--border-light); color: var(--text-main); padding: 12px; border-radius: 4px; font-size: 0.95rem; font-family: inherit; transition: var(--transition); }
        select:focus, input:focus, textarea:focus { outline: none; border-color: var(--accent-gold); box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2); }

        .btn { padding: 12px 20px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 0.85rem; transition: var(--transition); }
        .btn-gold { background: var(--accent-gold); color: #121418; }
        .btn-gold:hover { background: #bfa030; transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 1px solid var(--border-light); color: var(--text-dim); }
        .btn-outline:hover { border-color: var(--text-main); color: var(--text-main); }
        .btn-danger { background: rgba(239, 83, 80, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }

        .slider-container { margin-bottom: 25px; }
        .slider-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .slider-val { color: var(--accent-gold); font-weight: bold; font-family: monospace; font-size: 1.1rem; }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 8px; background: var(--bg-input); border-radius: 4px; outline: none; border: 1px solid var(--border-light); }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; border-radius: 50%; background: var(--accent-gold); cursor: pointer; border: 2px solid var(--bg-body); box-shadow: 0 2px 6px rgba(212, 175, 55, 0.4); }
        input[type="range"]::-moz-range-thumb { width: 22px; height: 22px; border-radius: 50%; background: var(--accent-gold); cursor: pointer; border: 2px solid var(--bg-body); box-shadow: 0 2px 6px rgba(212, 175, 55, 0.4); }

        .param-feedback { font-size: 0.8rem; color: var(--text-dim); margin-top: 5px; font-style: italic; border-left: 2px solid var(--border-light); padding-left: 8px; }
        .feedback-warn { color: var(--warning); border-color: var(--warning); }
        .feedback-good { color: var(--success); border-color: var(--success); }
        .feedback-danger { color: var(--danger); border-color: var(--danger); }

        .result-box { background: rgba(212, 175, 55, 0.05); border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 6px; padding: 15px; margin-top: 20px; }

        /* NEW STICKY PANEL LAYOUT FOR MOBILE */
        .sticky-panel { 
            position: sticky; 
            top: 48px; 
            z-index: 95; 
            background: var(--bg-panel); 
            border: 1px solid var(--accent-gold); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.5); 
            margin-bottom: 25px; 
            padding: 10px; 
            border-radius: 6px; 
        }

        .sticky-content {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .sticky-bars-col {
            flex: 1;
            min-width: 0; /* Prevent overflow */
        }

        .sticky-chart-col {
            width: 220px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-left: 1px solid var(--border-light);
            padding-left: 10px;
        }

        .chart-legend-mini {
            font-size: 0.65rem; 
            color: var(--text-dim); 
            text-align: center; 
            margin-top: 5px;
            line-height: 1.2;
        }

        .radar-container-mini {
            position: relative;
            width: 100%;
            height: 180px;
        }

        .perf-bar-container { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .perf-label-group { display: flex; flex-direction: column; width: 100px; text-align: right; flex-shrink: 0; }
        .perf-title { font-size: 0.75rem; font-weight: bold; color: var(--text-main); text-transform: uppercase; white-space: nowrap; }
        .perf-question { font-size: 0.6rem; color: var(--text-dim); font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .perf-track-wrapper { flex-grow: 1; display: flex; align-items: center; gap: 4px; }
        .perf-track { flex-grow: 1; height: 6px; background: var(--bg-input); border-radius: 3px; overflow: hidden; }
        .perf-fill { height: 100%; transition: width var(--transition); }
        .range-label { font-size: 0.6rem; color: var(--text-dim); white-space: nowrap; width: 50px; }

        .fill-depth { background: var(--accent-blue); }
        .fill-sep { background: var(--warning); }
        .fill-fine { background: var(--success); }
        .fill-id { background: var(--info); }
        .fill-mask { background: var(--danger); }

        .comparison-table { width: 100%; border-collapse: collapse; margin: 20px 0; background: var(--bg-input); border-radius: 6px; overflow: hidden; }
        .comparison-table th { background: rgba(92, 139, 192, 0.2); color: var(--accent-blue); padding: 12px; text-align: left; font-weight: bold; border-bottom: 2px solid var(--border-light); }
        .comparison-table td { padding: 12px; border-bottom: 1px solid var(--border-light); color: var(--text-main); }

        .id-scale { display: flex; height: 30px; border-radius: 4px; overflow: hidden; margin-top: 10px; font-size: 0.75rem; color: #000; font-weight: bold; }
        .id-zone { height: 100%; transition: width var(--transition); }

        .saved-item { background: var(--bg-input); border: 1px solid var(--border-light); padding: 15px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .saved-item:hover { border-color: var(--accent-gold); box-shadow: 0 2px 8px rgba(212, 175, 55, 0.1); }
        .saved-item-content h4 { color: var(--text-main); font-size: 1rem; margin-bottom: 4px; }
        .saved-item-content p { color: var(--text-dim); font-size: 0.85rem; }
        .saved-item-actions { display: flex; gap: 8px; }
        .saved-item-actions button { padding: 6px 12px; font-size: 0.75rem; border-radius: 4px; border: none; cursor: pointer; transition: var(--transition); }

        .btn-download { background: rgba(212, 175, 55, 0.2); color: var(--accent-gold); border: 1px solid var(--accent-gold); }
        .btn-download:hover { background: var(--accent-gold); color: #121418; }
        .btn-delete { background: rgba(239, 83, 80, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .btn-delete:hover { background: var(--danger); color: white; }

        .alert { padding: 12px; border-radius: 4px; margin: 10px 0; font-size: 0.9rem; border-left: 3px solid; }
        .alert-info { background: rgba(92, 139, 192, 0.1); border-color: var(--accent-blue); }
        .alert-warn { background: rgba(255, 167, 38, 0.1); border-color: var(--warning); }
        .alert-success { background: rgba(102, 187, 106, 0.1); border-color: var(--success); }

        .terrain-card { background: var(--bg-input); border: 1px solid var(--border-light); padding: 15px; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .terrain-card:hover { border-color: var(--accent-gold); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2); }
        .terrain-card h3 { color: var(--accent-gold); margin-bottom: 8px; }
        .terrain-card p { color: var(--text-dim); font-size: 0.9rem; margin: 4px 0; }

        .faq-item { margin-bottom: 20px; padding: 15px; background: var(--bg-input); border-left: 3px solid var(--accent-gold); border-radius: 4px; }
        .faq-item strong { color: var(--accent-blue); }

        /* MOBILE OPTIMIZATIONS FOR STICKY PANEL */
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            header { flex-direction: column; text-align: center; }
            
            .sticky-panel { padding: 8px 5px; top: 45px; }
            .sticky-content { gap: 5px; }
            
            /* Chart adjustments for mobile */
            .sticky-chart-col { 
                width: 110px; /* Much smaller chart */
                border-left: none; /* Save space */
                padding-left: 2px;
            }
            .radar-container-mini { height: 110px; } /* Square aspect ratio */
            .chart-legend-mini { font-size: 0.55rem; display: block; } /* Ensure legend wraps */

            /* Bar adjustments for mobile */
            .perf-label-group { width: 70px; } /* Narrower label col */
            .perf-title { font-size: 0.65rem; }
            .perf-question { display: none; } /* HIDE questions on mobile */
            .range-label { display: none; } /* Hide start/end labels on mobile to save width */
            .perf-track { height: 5px; } /* Thinner bars */
        }
    </style>
</head>
<body>

    <header>
        <div>
            <h1>‚ö° XP Deus II V5</h1>
            <p>CONSOLE EXPERT PRO | V4.3 (MOBILE UI)</p>
        </div>
        <div class="header-right">
            <button class="theme-toggle" onclick="toggleTheme()">üåô Th√®me</button>
        </div>
    </header>

    <div class="nav-container" id="nav-tabs">
        <button class="nav-btn active" onclick="setTab('config')">‚ö° Configuration</button>
        <button class="nav-btn" onclick="setTab('terrains')">üåç Terrains</button>
        <button class="nav-btn" onclick="setTab('profiles')">üíæ Profils</button>
        <button class="nav-btn" onclick="setTab('tools')">üÜî Outils</button>
        <button class="nav-btn" onclick="setTab('faq')">‚ùì FAQ</button>
    </div>

    <div class="container">
        <!-- CONFIG TAB (WIZARD + SIMULATOR + EXPERT + ADVANCED) -->
        <div id="config" class="tab-content active">
            
            <!-- STEP 1: WIZARD & CONTEXT -->
            <div class="card" style="border-left: 4px solid var(--accent-gold);">
                <h2>1Ô∏è‚É£ Assistant de D√©marrage</h2>
                <p style="color:var(--text-dim); margin-bottom:15px;">Commencez par d√©finir votre environnement pour obtenir le meilleur programme.</p>
                <div class="grid-2">
                    <div>
                        <label>Terrain</label>
                        <select id="wiz-terrain">
                            <option value="">-- S√©lectionner le terrain --</option>
                            <option value="prairie">üåæ Prairie / Champ propre</option>
                            <option value="min√©ralis√©">üî¥ Sol min√©ralis√© (Argile rouge)</option>
                            <option value="pollu√©">üî© Terrain tr√®s pollu√© (Ferraille)</option>
                            <option value="plage">üèñÔ∏è Plage (Sable sec/humide)</option>
                            <option value="eau">üíß Eau douce</option>
                        </select>
                    </div>
                    <div>
                        <label>Objectif</label>
                        <select id="wiz-obj">
                            <option value="">-- S√©lectionner la cible --</option>
                            <option value="monnaies">üí∞ Monnaies Anciennes</option>
                            <option value="or">‚ú® Or & Bijoux</option>
                            <option value="reliques">üèõÔ∏è Reliques & Militaria</option>
                            <option value="profond">üîç Masses Profondes</option>
                            <option value="tout">üéØ Polyvalent</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-gold" style="width:100%; margin-top:20px; font-size:1.1rem;" onclick="runWizardCheck()">üöÄ TROUVER LE PROGRAMME OPTIMAL</button>
            </div>

            <!-- STEP 2: RESULT & FACTORY SELECTION -->
            <div id="wizard-outcome" style="display:none; animation: fadeEffect 0.5s;">
                <div class="card" style="border: 2px solid var(--accent-blue); background:rgba(92, 139, 192, 0.05);">
                    <h2>2Ô∏è‚É£ Programme Recommand√©</h2>
                    
                    <div id="wiz-recommendation-text" style="margin-bottom:20px; font-size:1.1rem;"></div>

                    <div style="background:var(--bg-panel); padding:15px; border-radius:6px; border:1px solid var(--border-light);">
                        <label style="color:var(--accent-gold); font-weight:bold;">Changer de Base (Programme d'usine)</label>
                        <div style="display:flex; gap:10px; align-items:center; margin-top:8px;">
                            <select id="sel-factory-prog" style="flex:1;" onchange="manualProgramChange()">
                                <option value="">-- Choisir un programme --</option>
                                <!-- Options generated by JS -->
                            </select>
                            <span style="font-size:0.8rem; color:var(--text-dim);">Modifie instantan√©ment le simulateur ci-dessous üëá</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ANALYSE TACTIQUE GLOBALE (STICKY & RESPONSIVE) -->
            <div class="sticky-panel">
                <div class="sticky-content">
                    <!-- LEFT COL: BARS -->
                    <div class="sticky-bars-col">
                        <label style="margin-bottom:8px; color:var(--accent-gold); font-weight:bold; display:block; font-size:0.9rem;">üìä ANALYSE TACTIQUE</label>
                        
                        <div class="perf-bar-container">
                            <div class="perf-label-group"><span class="perf-title">Puissance</span><span class="perf-question">√Ä quelle profondeur ?</span></div>
                            <div class="perf-track-wrapper">
                                <span class="range-label">Surface</span>
                                <div class="perf-track"><div id="bar-depth" class="perf-fill fill-depth" style="width:0%"></div></div>
                                <span class="range-label">Profond</span>
                            </div>
                        </div>
                        <div class="perf-bar-container">
                            <div class="perf-label-group"><span class="perf-title">S√©paration</span><span class="perf-question">Pi√®ce au milieu de clous ?</span></div>
                            <div class="perf-track-wrapper">
                                <span class="range-label">Amalgame</span>
                                <div class="perf-track"><div id="bar-sep" class="perf-fill fill-sep" style="width:0%"></div></div>
                                <span class="range-label">S√©par√©</span>
                            </div>
                        </div>
                        <div class="perf-bar-container">
                            <div class="perf-label-group"><span class="perf-title">Finesse</span><span class="perf-question">Objets minuscules ?</span></div>
                            <div class="perf-track-wrapper">
                                <span class="range-label">Standard</span>
                                <div class="perf-track"><div id="bar-fine" class="perf-fill fill-fine" style="width:0%"></div></div>
                                <span class="range-label">Extra Fin</span>
                            </div>
                        </div>
                        <div class="perf-bar-container">
                            <div class="perf-label-group"><span class="perf-title">Discrim.</span><span class="perf-question">Or ou vieux clou ?</span></div>
                            <div class="perf-track-wrapper">
                                <span class="range-label">Tout M√©tal</span>
                                <div class="perf-track"><div id="bar-id" class="perf-fill fill-id" style="width:0%"></div></div>
                                <span class="range-label">Filtre Max</span>
                            </div>
                        </div>
                        <div class="perf-bar-container">
                            <div class="perf-label-group"><span class="perf-title" style="color:var(--danger);">‚ö†Ô∏è Masquage</span><span class="perf-question">Cibles manqu√©es ?</span></div>
                            <div class="perf-track-wrapper">
                                <span class="range-label">Faible</span>
                                <div class="perf-track"><div id="bar-mask" class="perf-fill fill-mask" style="width:0%"></div></div>
                                <span class="range-label">√âlev√©</span>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COL: CHART -->
                    <div class="sticky-chart-col">
                        <div class="radar-container-mini">
                            <canvas id="radarChart"></canvas>
                        </div>
                        <div class="chart-legend-mini">
                            <span style="color:#d4af37;">‚óè Actuel</span> &nbsp;|&nbsp; <span style="color:#a0a0a0;">-- Usine</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SIMULATOR SECTION -->
            <div class="card">
                <h2>3Ô∏è‚É£ Simulateur Interactif & Ajustements</h2>
                <p style="color:var(--text-dim); margin-bottom:20px;">Affinez les r√©glages du programme s√©lectionn√©.</p>

                <div class="grid-2" style="margin-top: 20px;">
                    <div>
                        <h4 style="color:var(--accent-blue); margin-bottom:15px; border-bottom: 1px solid var(--border-light); padding-bottom: 10px;">‚ö° Puissance & Vitesse</h4>
                        <div class="slider-container">
                            <div class="slider-header"><label>Sensibilit√© (Standard)</label><span id="val-sens" class="slider-val">93</span></div>
                            <input type="range" id="rng-sens" min="70" max="99" value="93" oninput="updateSimulator()">
                            <div id="feed-sens" class="param-feedback">Zone optimale pour la plupart des terrains.</div>
                        </div>
                        <div class="slider-container">
                            <div class="slider-header"><label>R√©activit√© (Standard)</label><span id="val-reac" class="slider-val">2.0</span></div>
                            <input type="range" id="rng-reac" min="0" max="5" step="0.5" value="2" oninput="updateSimulator()">
                            <div id="feed-reac" class="param-feedback">Vitesse standard. Bon compromis.</div>
                        </div>
                        <h4 style="color:var(--accent-blue); margin-top:25px; margin-bottom:15px; border-bottom: 1px solid var(--border-light); padding-bottom: 10px;">üîç Filtres & Rejets</h4>
                        <div class="slider-container">
                            <div class="slider-header"><label>Discrimination</label><span id="val-disc" class="slider-val">10</span></div>
                            <input type="range" id="rng-disc" min="-6" max="40" value="10" oninput="updateSimulator()">
                            <div id="feed-disc" class="param-feedback">Rejet classique des ferreux.</div>
                        </div>
                        <div class="slider-container">
                            <div class="slider-header"><label>Silencieux (Silencer)</label><span id="val-sil" class="slider-val">1</span></div>
                            <input type="range" id="rng-sil" min="0" max="5" value="1" oninput="updateSimulator()">
                            <div id="feed-sil" class="param-feedback">Standard. Filtre peu de craquements.</div>
                        </div>
                        <div class="slider-container">
                            <div class="slider-header"><label>B.Caps (Rejet Capsules)</label><span id="val-bcaps" class="slider-val">0</span></div>
                            <input type="range" id="rng-bcaps" min="0" max="5" value="0" oninput="updateSimulator()">
                            <div id="feed-bcaps" class="param-feedback">Filtre d√©sactiv√©.</div>
                        </div>
                        <div class="slider-container">
                            <div class="slider-header"><label>Notch (Encoche)</label><span id="val-notch" class="slider-val">OFF</span></div>
                            <input type="range" id="rng-notch" min="0" max="60" value="0" oninput="updateSimulator()">
                            <div id="feed-notch" class="param-feedback">Aucune fr√©quence rejet√©e.</div>
                        </div>
                    </div>

                    <div>
                        <h4 style="color:var(--fmf); margin-bottom:15px; border-bottom: 1px solid var(--border-light); padding-bottom: 10px;">üåä FMF Strategy & Audio</h4>
                        <div style="margin-bottom:20px; border:1px solid var(--fmf); padding:10px; border-radius:6px; background:rgba(179, 136, 255, 0.05);">
                            <label style="color:var(--fmf); font-weight:bold;">Strat√©gie FMF</label>
                            <select id="sel-fmf" onchange="updateSimulator()">
                                <option value="general">FMF Standard (4-45kHz) - Polyvalent</option>
                                <option value="sensitive">FMF Sensitive (40kHz Max) - Petites cibles</option>
                                <option value="deep">FMF Deep (14kHz Max) - Grosses masses</option>
                                <option value="park">FMF Park (24kHz Max) - Zones pollu√©es</option>
                                <option value="beach">FMF Beach (Sable/Sel) - Conductivit√©</option>
                                <option value="gold">FMF Gold (Haute Freq) - P√©pites</option>
                            </select>
                            <div id="feed-fmf" class="param-feedback" style="color:var(--text-dim); margin-top:5px;">Balayage multi-fr√©quence standard.</div>
                        </div>
                        <div class="slider-container">
                            <div class="slider-header"><label>Type Audio</label><span id="val-audio" class="slider-val">Square</span></div>
                            <select id="sel-audio" onchange="updateSimulator()">
                                <option value="Pitch">üîä Pitch (Classique & Percutant)</option>
                                <option value="Square" selected>üìä Square (Num√©rique/Net)</option>
                                <option value="Morphing">üåä Morphing (Expert)</option>
                                <option value="2-Tones">üéµ 2-Tons (S√©paration)</option>
                                <option value="FullTones">üéπ Full Tones (Nuances riches)</option>
                            </select>
                            <div id="feed-audio" class="param-feedback">Audio standard.</div>
                        </div>

                        <!-- MORPHING SUB-CONFIG (HIDDEN BY DEFAULT) -->
                        <div id="morphing-config" style="display:none; background:rgba(92, 139, 192, 0.1); border-left:3px solid var(--accent-gold); padding:10px; margin-bottom:20px; border-radius:4px;">
                             <div class="slider-header"><label style="color:var(--accent-gold);">Mode Morphing (4 Modes)</label></div>
                             <select id="sel-morphing-mode" onchange="updateSimulator()" style="margin-top:5px;">
                                 <option value="1">Mode 1: Continu (Profondeur)</option>
                                 <option value="2">Mode 2: Seuil (R√©actif)</option>
                                 <option value="3">Mode 3: Logarithmique (Boost Faibles)</option>
                                 <option value="4">Mode 4: Hybride (Filtre Fer)</option>
                             </select>
                             <div class="param-feedback" id="feed-morphing-sub">S√©lectionnez la courbe de r√©ponse.</div>
                        </div>

                        <div class="slider-container">
                            <div class="slider-header"><label>R√©ponse Audio</label><span id="val-resp" class="slider-val">4</span></div>
                            <input type="range" id="rng-resp" min="0" max="7" value="4" oninput="updateSimulator()">
                            <div id="feed-resp" class="param-feedback">Standard. Les cibles profondes sonnent un peu plus faible.</div>
                        </div>
                        <div class="slider-container">
                            <div class="slider-header"><label>Volume Fer</label><span id="val-iron" class="slider-val">3</span></div>
                            <input type="range" id="rng-iron" min="0" max="5" value="3" oninput="updateSimulator()">
                            <div id="feed-iron" class="param-feedback">Audio ON. Vous entendez le fer en grave.</div>
                        </div>
                    </div>
                </div>

                <div id="sim-analysis" class="result-box"></div>
            </div>

            <!-- ADVANCED SETTINGS CARD (MOVED HERE) -->
            <div class="card" style="border-left: 3px solid var(--info);">
                <h2>üéõÔ∏è R√©glages Avanc√©s (Sol & Stabilit√©)</h2>
                <div class="grid-2">
                    <div>
                        <h4 style="color:var(--accent-blue); margin-bottom:15px;">üéØ Sol & Stabilit√©</h4>
                        <div class="slider-container">
                            <div class="slider-header"><label>Ground Stabilizer</label><span id="val-stab" class="slider-val">2</span></div>
                            <input type="range" id="rng-stab" min="0" max="3" value="2" oninput="updateAdvanced(); updateSimulator();">
                            <div id="feed-stab" class="param-feedback">Standard pour min√©ralis√©.</div>
                        </div>
                    </div>
                    <div>
                        <h4 style="color:var(--accent-blue); margin-bottom:15px;">üåç Ground Grab</h4>
                        <div class="slider-container">
                            <div class="slider-header"><label>GB Manual</label><span id="val-grab" class="slider-val">AUTO</span></div>
                            <input type="range" id="rng-grab" min="60" max="90" value="90" oninput="updateAdvanced(); updateSimulator();">
                            <div id="feed-grab" class="param-feedback">90 (Rejet par d√©faut).</div>
                        </div>
                    </div>
                </div>
                <!-- AJOUT DU DIV MANQUANT POUR LE FEEDBACK AVANCE -->
                <div id="advanced-feedback" class="result-box" style="margin-top:15px;"></div>
            </div>

            <!-- EXPERT V4 SECTION -->
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>üî• Mode Expert : Multi-Processing V4</h2>
                    <span class="badge badge-risky">AVANC√â</span>
                </div>
                <p style="margin-bottom:20px; color:var(--text-dim);">Le V4 permet de dissocier les traitements de signaux. Choisissez une strat√©gie pour prioriser les canaux.</p>

                <!-- Processing Mode Selection -->
                <div style="margin-bottom:25px; border:1px solid var(--accent-gold); padding:15px; border-radius:6px; background:rgba(212, 175, 55, 0.05);">
                    <label style="color:var(--accent-gold); font-weight:bold; font-size:1rem;">üì° Type de Multi-Processing</label>
                    <select id="sel-process-mode" onchange="updateExpert(); updateSimulator();" style="margin-top:8px;">
                        <option value="standard" selected>0. Standard (D√©sactiv√©)</option>
                        <option value="fusion">1. Fusion Parall√®le (√âquilibr√© V1+V2)</option>
                        <option value="depth">2. Priorit√© Profondeur (Boost V1)</option>
                        <option value="sep">3. Priorit√© S√©paration (Boost V2 / PWM)</option>
                    </select>
                    <div class="param-feedback" style="color:var(--text-main); margin-top:5px;">D√©finit comment le d√©tecteur combine les deux voies de traitement.</div>
                </div>

                <div class="grid-2">
                    <div style="border:1px solid var(--accent-blue); padding:20px; border-radius:6px; background:rgba(92, 139, 192, 0.05);">
                        <h3 style="color:var(--accent-blue); text-transform:uppercase; font-size:1rem; margin-bottom:15px;">üìç Voie 1 : Profondeur (Low)</h3>
                        <div class="slider-container">
                            <div class="slider-header"><label>R√©activit√© V1</label><span id="val-v1-reac" class="slider-val">1.0</span></div>
                            <input type="range" id="rng-v1-reac" min="0" max="2.5" step="0.5" value="1" oninput="updateExpert(); updateSimulator();">
                            <div id="feed-v1-reac" class="param-feedback">P√©n√©tration maximale.</div>
                        </div>
                        <div class="slider-container">
                            <div class="slider-header"><label>Sensibilit√© V1</label><span id="val-v1-sens" class="slider-val">95</span></div>
                            <input type="range" id="rng-v1-sens" min="80" max="99" value="95" oninput="updateExpert(); updateSimulator();">
                            <div id="feed-v1-sens" class="param-feedback">Haute puissance pour profondeur.</div>
                        </div>
                    </div>

                    <div style="border:1px solid var(--warning); padding:20px; border-radius:6px; background:rgba(255, 167, 38, 0.05);">
                        <h3 style="color:var(--warning); text-transform:uppercase; font-size:1rem; margin-bottom:15px;">‚ö° Voie 2 : S√©paration (High)</h3>
                        <div class="slider-container">
                            <div class="slider-header"><label>R√©activit√© V2</label><span id="val-v2-reac" class="slider-val">3.5</span></div>
                            <input type="range" id="rng-v2-reac" min="2.5" max="5" step="0.5" value="3.5" oninput="updateExpert(); updateSimulator();">
                            <div id="feed-v2-reac" class="param-feedback">Excellente s√©paration.</div>
                        </div>
                        <div class="slider-container">
                            <div class="slider-header"><label>Sensibilit√© V2</label><span id="val-v2-sens" class="slider-val">90</span></div>
                            <input type="range" id="rng-v2-sens" min="80" max="99" value="90" oninput="updateExpert(); updateSimulator();">
                            <div id="feed-v2-sens" class="param-feedback">Stabilit√© contr√¥l√©e.</div>
                        </div>
                    </div>
                </div>

                <div id="expert-feedback" class="result-box"></div>
            </div>
        </div>

        <!-- TERRAINS TAB -->
        <div id="terrains" class="tab-content">
            <div class="card">
                <h2>üåç Encyclop√©die des Terrains</h2>
                <p style="color:var(--text-dim); margin-bottom:20px;">Cliquez sur une carte pour voir la fiche technique d√©taill√©e.</p>
                <div id="terrain-grid" class="grid-3"></div>
            </div>
            <div id="terrain-detail"></div>
        </div>

        <!-- PROFILES TAB -->
        <div id="profiles" class="tab-content">
            <div class="card">
                <h2>üíæ Sauvegarder Mes Configurations</h2>
                <div class="grid-2">
                    <div>
                        <label>Nom du profil</label>
                        <input type="text" id="profile-name" placeholder="Ex: Prairie - Monnaies">
                    </div>
                    <div>
                        <label>Terrain / Objectif</label>
                        <input type="text" id="profile-terrain" placeholder="Ex: Prairie min√©ralis√©e - Or fin">
                    </div>
                </div>
                <button class="btn btn-gold" style="width:100%; margin-top:12px;" onclick="saveProfile()">üíæ Enregistrer Config Actuelle</button>
                <p style="font-size:0.8rem; color:var(--text-dim); margin-top:10px;">*Sauvegarde tous les param√®tres des onglets Simulateur et Expert.</p>
            </div>

            <div class="card">
                <h2>üìã Mes Profils Enregistr√©s</h2>
                <div id="saved-profiles-list">
                    <p style="color:var(--text-dim); text-align:center; padding:20px;">Aucun profil sauvegard√©.</p>
                </div>
            </div>
        </div>

        <!-- TOOLS TAB -->
        <div id="tools" class="tab-content">
            <div class="card">
                <h2>üÜî Guide Visuel des Indices (Target ID)</h2>
                <p style="color:var(--text-dim); margin-bottom:15px;">R√©f√©rence rapide pour identifier les cibles selon l'indice affich√©.</p>
                
                <div style="margin-bottom:30px;">
                    <div class="id-scale">
                        <div class="id-zone" style="width:10%; background:#ef5350;">FER</div>
                        <div class="id-zone" style="width:20%; background:#ffa726;">OR/ALU</div>
                        <div class="id-zone" style="width:30%; background:#ffee58; color:#000;">BRONZE</div>
                        <div class="id-zone" style="width:30%; background:#66bb6a;">ARGENT</div>
                        <div class="id-zone" style="width:10%; background:#29b6f6;">GROS</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:var(--text-dim); margin-top:5px;">
                        <span>0</span><span>10</span><span>30</span><span>60</span><span>90</span><span>99</span>
                    </div>
                </div>

                <div class="grid-2">
                    <ul style="font-size:0.9rem; color:var(--text-main); list-style-position: inside;">
                        <li><strong style="color:#ef5350;">00-09:</strong> Ferreux (Clous, fers √† cheval)</li>
                        <li><strong style="color:#ffa726;">10-25:</strong> Aluminium, Petit Or, Bijoux</li>
                        <li><strong style="color:#ffee58;">26-50:</strong> Nickel, Cartouches, Bronze</li>
                    </ul>
                    <ul style="font-size:0.9rem; color:var(--text-main); list-style-position: inside;">
                        <li><strong style="color:#66bb6a;">51-85:</strong> Cuivre, Monnaies, Bronze large</li>
                        <li><strong style="color:#29b6f6;">86-99:</strong> Grosses masses, Argent, Hot Rocks</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h2>üìù Carnet de D√©couvertes</h2>
                <div class="grid-2">
                    <div>
                        <label>Trouvaille</label>
                        <input type="text" id="log-find" placeholder="Ex: Napol√©on III">
                    </div>
                    <div>
                        <label>Profondeur (cm)</label>
                        <input type="number" id="log-depth" placeholder="20">
                    </div>
                </div>
                <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="addLog()">‚ûï Ajouter au journal</button>
                <div id="logbook-list" style="margin-top:20px;"></div>
            </div>
        </div>

        <!-- FAQ TAB -->
        <div id="faq" class="tab-content">
            <div class="card">
                <h2>‚ùì Foire Aux Questions</h2>
                <div id="faq-container"></div>
            </div>
        </div>
    </div>

    <script>
        const DATA = {
            objectives: {
                monnaies: { label: "Monnaies Anciennes", sens: 93, reac: 1.5, disc: 8, audio: "Square", conseil: "Priorisez la profondeur avec r√©activit√© basse et audio nette." },
                or: { label: "Or & Bijoux", sens: 96, reac: 2.5, disc: 2, audio: "Morphing", conseil: "Sensibilit√© maximale requise. Ne discriminez pas (0-5) pour ne pas rater l'or fin." },
                reliques: { label: "Reliques & Militaria", sens: 90, reac: 2.5, disc: 10, audio: "2-Tones", conseil: "Bon √©quilibre profondeur/s√©paration. 2-Tones aide √† trier le fer." },
                profond: { label: "Masses Profondes", sens: 97, reac: 0, disc: 5, audio: "Morphing", conseil: "R√©activit√© 0 indispensable pour extr√™me profondeur. Balayage lent obligatoire." },
                tout: { label: "Polyvalent", sens: 92, reac: 2, disc: 10, audio: "Square", conseil: "Meilleur compromis pour d√©buter une zone inconnue." }
            },
            terrains: {
                prairie: { name: "üåæ Prairie / Champ Propre", depth: "50-70 cm", poll: "Faible", config: { sens: 95, reac: 1, disc: 8 }, tips: ["R√©activit√© 0-1 pour profondeur max", "Sensibilit√© 95-99 possible", "Balayez lentement"] },
                min√©ralis√©: { name: "üî¥ Sol Min√©ralis√© (Argile rouge)", depth: "30-45 cm", poll: "Moyenne", config: { sens: 88, reac: 2.5, disc: 10 }, tips: ["Ground Stabilizer 2-3 ESSENTIEL", "FMF Multi-High pour sortir cibles du bruit", "GRAB r√©gulier n√©cessaire"] },
                pollu√©: { name: "üî© Terrain Pollu√© (Ferraille)", depth: "25-40 cm", poll: "TR√àS HAUTE", config: { sens: 87, reac: 3, disc: 10 }, tips: ["R√©activit√© 3+ OBLIGATOIRE", "Audio 2-Tones ou Pitch pour s√©parer", "Silencer 1-2 pour calmer le fer"] },
                plage: { name: "üèñÔ∏è Plage (Sable)", depth: "35-50 cm", poll: "Alu/Sel", config: { sens: 92, reac: 2, disc: 15 }, tips: ["Mode BEACH indispensable", "GB vers 23-27 sur sable mouill√©", "Sable noir = min√©ralisation extr√™me"] },
                eau: { name: "üíß Eau Douce", depth: "40-60 cm", poll: "Faible", config: { sens: 93, reac: 2, disc: 5 }, tips: ["Discrimination basse (0-5)", "FMF 14/28 kHz optimal", "Balayage r√©gulier et lent"] }
            },
            factoryPrograms: {
                general: { label: "1. GENERAL", sens: 93, reac: 2.5, disc: 10, iron: 3, resp: 4, audio: "Square", fmf: "general", sil: 2, bcaps: 0, notch: 0 },
                sensitive: { label: "2. SENSITIVE", sens: 90, reac: 2.5, disc: 6.8, iron: 3, resp: 4, audio: "Square", fmf: "sensitive", sil: 1, bcaps: 0, notch: 0 },
                sensi_ft: { label: "3. SENSI FT", sens: 90, reac: 2.5, disc: 6.8, iron: 3, resp: 4, audio: "FullTones", fmf: "sensitive", sil: 1, bcaps: 0, notch: 0 },
                fast: { label: "4. FAST", sens: 90, reac: 3, disc: 6.8, iron: 3, resp: 4, audio: "Pitch", fmf: "park", sil: 1, bcaps: 0, notch: 0 },
                park: { label: "5. PARK", sens: 90, reac: 2.5, disc: 7, iron: 3, resp: 4, audio: "Square", fmf: "park", sil: 2, bcaps: 3, notch: 23 },
                deep_hc: { label: "6. DEEP HC", sens: 93, reac: 2, disc: 7, iron: 3, resp: 5, audio: "Square", fmf: "deep", sil: 2, bcaps: 0, notch: 0 },
                deus_mono: { label: "7. DEUS MONO", sens: 90, reac: 2.5, disc: 7, iron: 3, resp: 4, audio: "Square", fmf: "general", sil: 1, bcaps: 0, notch: 0 },
                gold_field: { label: "8. GOLD FIELD", sens: 95, reac: 2.5, disc: 0, iron: 0, resp: 4, audio: "Pitch", fmf: "gold", sil: 0, bcaps: 0, notch: 0 },
                relic: { label: "9. RELIC", sens: 95, reac: 2, disc: 0, iron: 0, resp: 5, audio: "Pitch", fmf: "deep", sil: 0, bcaps: 0, notch: 0 },
                diving: { label: "10. DIVING", sens: 95, reac: 2, disc: 8, iron: 3, resp: 4, audio: "Square", fmf: "general", sil: 1, bcaps: 0, notch: 0 },
                beach: { label: "11. BEACH", sens: 95, reac: 0, disc: 8, iron: 3, resp: 4, audio: "Square", fmf: "beach", sil: 1, bcaps: 0, notch: 0 },
                beach_sens: { label: "12. BEACH SENS", sens: 95, reac: 1, disc: 8, iron: 3, resp: 4, audio: "Square", fmf: "beach", sil: 1, bcaps: 0, notch: 0 }
            },
            faq: [
                { q: "Quelle sensibilit√© pour prairie?", r: "93-95 pour meilleur √©quilibre. Au-del√† = risque masquage des petites cibles." },
                { q: "R√©activit√© 0 = profondeur max?", r: "Oui, mais tr√®s lent. N√©cessite 30-50cm par coup. Id√©al pour recherche statique." },
                { q: "Comment fonctionne le V4?", r: "Deux signaux parall√®les: Voie 1 pour profondeur (faible r√©ac), Voie 2 pour s√©paration (haute r√©ac)." },
                { q: "Discrimination n√©gative possible?", r: "Oui (-6 √† +40). N√©gatif = accepte fer fin. Utile en terrain tr√®s propre." },
                { q: "Morphing vs Square?", r: "Morphing = variable selon profondeur. Square = constant et net. Morphing meilleur pour profondeur." },
                { q: "FMF Park pour zones pollu√©es?", r: "Oui, id√©al. Fr√©quence max 24kHz rejette bruits m√©talliques parasites." }
            ]
        };

        let radarChart = null;
        let wizardCalculatedConfig = null;
        let referenceStats = null; // Store reference data for comparison

        function toggleTheme() {
            const theme = localStorage.getItem('theme') || 'dark';
            const newTheme = theme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            document.documentElement.setAttribute('data-theme', newTheme);
        }

        window.addEventListener('load', () => {
            const theme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            
            // Populate Factory Programs Dropdown
            const progSelect = document.getElementById('sel-factory-prog');
            if (progSelect) {
                Object.keys(DATA.factoryPrograms).forEach(key => {
                    const prog = DATA.factoryPrograms[key];
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = prog.label;
                    progSelect.appendChild(option);
                });
            }

            loadTerrainGrid();
            loadFAQ();
            loadProfilesList();
            loadLogbook();
            updateSimulator();
            setTimeout(() => {
                if(document.getElementById('radarChart')) initRadarChart();
            }, 500);
        });

        function setTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            const target = document.getElementById(tabName);
            if(target) target.classList.add('active');
            
            const btn = event ? event.currentTarget : document.querySelector(`.nav-btn[onclick="setTab('${tabName}')"]`);
            if(btn) btn.classList.add('active');

            if (tabName === 'config') {
                setTimeout(() => {
                   if (!radarChart) initRadarChart();
                   else radarChart.update();
                }, 100);
            }
        }

        function loadTerrainGrid() {
            const grid = document.getElementById('terrain-grid');
            grid.innerHTML = Object.keys(DATA.terrains).map(key => {
                const t = DATA.terrains[key];
                return `<div class="terrain-card" onclick="showTerrainDetail('${key}')">
                    <h3>${t.name}</h3>
                    <p><strong>Profondeur:</strong> ${t.depth}</p>
                    <p><strong>Pollution:</strong> ${t.poll}</p>
                    <p style="color:var(--accent-gold); font-size:0.85rem; margin-top:10px;">üëÜ Cliquez pour d√©tails</p>
                </div>`;
            }).join('');
        }

        function showTerrainDetail(key) {
            const t = DATA.terrains[key];
            const detail = document.getElementById('terrain-detail');
            detail.innerHTML = `<div class="card" style="border-left: 4px solid var(--accent-gold);">
                <h2>${t.name} - Fiche Technique</h2>
                <div class="grid-2">
                    <div>
                        <h4 style="color:var(--accent-blue); margin-bottom:10px;">üìä Configuration Recommand√©e</h4>
                        <p><strong>Sensibilit√©:</strong> ${t.config.sens}</p>
                        <p><strong>R√©activit√©:</strong> ${t.config.reac}</p>
                        <p><strong>Discrimination:</strong> ${t.config.disc}</p>
                    </div>
                    <div>
                        <h4 style="color:var(--accent-blue); margin-bottom:10px;">üí° Conseils Experts</h4>
                        <ul>${t.tips.map(tip => `<li>‚Ä¢ ${tip}</li>`).join('')}</ul>
                    </div>
                </div>
                <button class="btn btn-gold" style="width:100%; margin-top:15px;" onclick="applyTerrainConfig('${key}')">üöÄ Appliquer cette config</button>
            </div>`;
        }

        function applyTerrainConfig(key) {
            const t = DATA.terrains[key];
            document.getElementById('rng-sens').value = t.config.sens;
            document.getElementById('rng-reac').value = t.config.reac;
            document.getElementById('rng-disc').value = t.config.disc;
            setTab('config');
            updateSimulator();
            alert('‚úÖ Configuration terrain appliqu√©e!');
        }

        // --- CORE FUNCTION FOR WIZARD LOGIC ---
        function runWizardCheck() {
            const terrain = document.getElementById('wiz-terrain').value;
            const obj = document.getElementById('wiz-obj').value;

            if (!terrain || !obj) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner un terrain et un objectif.');
                return;
            }

            // MAPPING LOGIC: Terrain + Obj => Factory Program Key
            let recommendedKey = 'general';
            let reason = "Programme polyvalent par d√©faut.";

            if (terrain === 'plage') {
                recommendedKey = 'beach';
                reason = "Pour compenser le sel et le sable mouill√©.";
                if (obj === 'profond') { recommendedKey = 'beach_sens'; reason = "Plage avec recherche de profondeur maximale."; }
            } 
            else if (terrain === 'eau') {
                recommendedKey = 'diving'; 
                reason = "Programme √©tanche stable pour immersion.";
            }
            else if (obj === 'or') {
                recommendedKey = 'gold_field';
                reason = "Mode Gold Field sp√©cifique pour les p√©pites.";
            }
            else if (terrain === 'pollu√©') {
                recommendedKey = 'park';
                reason = "FMF Park g√®re mieux la pollution ferreuse moderne.";
                if (obj === 'monnaies') { recommendedKey = 'fast'; reason = "Programme Fast pour l'ultra-r√©activit√©."; }
            }
            else if (obj === 'profond') {
                recommendedKey = 'deep_hc';
                reason = "Deep HC pour chercher les masses profondes.";
                if (obj === 'reliques') { recommendedKey = 'relic'; reason = "Programme Relic pour les grosses cibles profondes."; }
            }
            else if (obj === 'monnaies') {
                if (terrain === 'prairie') { recommendedKey = 'general'; reason = "General est excellent en prairie propre."; }
                else if (terrain === 'min√©ralis√©') { recommendedKey = 'sensitive'; reason = "Sensitive g√®re mieux la min√©ralisation l√©g√®re."; }
            }

            // Apply the logic
            document.getElementById('wizard-outcome').style.display = 'block';
            
            const progName = DATA.factoryPrograms[recommendedKey].label;
            document.getElementById('wiz-recommendation-text').innerHTML = `
                <strong style="color:var(--accent-gold); font-size:1.3rem;">${progName}</strong><br>
                <span style="color:var(--text-main); font-style:italic;">"${reason}"</span>
            `;

            // Auto-select in dropdown and load
            const dropdown = document.getElementById('sel-factory-prog');
            dropdown.value = recommendedKey;
            
            // Trigger load function manually
            loadProgramByKey(recommendedKey);

            // Scroll to result
            document.getElementById('wizard-outcome').scrollIntoView({behavior: 'smooth'});
        }

        function manualProgramChange() {
            const key = document.getElementById('sel-factory-prog').value;
            if (key) loadProgramByKey(key);
        }

        function loadProgramByKey(key) {
            const p = DATA.factoryPrograms[key];
            if (!p) return;

            // RESET EXPERT MODE TO STANDARD TO AVOID CONFLICTS
            document.getElementById('sel-process-mode').value = 'standard';

            document.getElementById('rng-sens').value = p.sens;
            document.getElementById('rng-reac').value = p.reac;
            document.getElementById('rng-disc').value = p.disc;
            document.getElementById('rng-sil').value = p.sil;
            document.getElementById('rng-bcaps').value = p.bcaps;
            document.getElementById('rng-notch').value = p.notch;
            
            const fmfSel = document.getElementById('sel-fmf');
            fmfSel.value = p.fmf;
            if (fmfSel.selectedIndex === -1) fmfSel.value = 'general';

            document.getElementById('sel-audio').value = p.audio;
            document.getElementById('rng-resp').value = p.resp;
            document.getElementById('rng-iron').value = p.iron;

            // CALIBRATION: CALCULATE & STORE REFERENCE STATS
            referenceStats = calculatePerfFromValues(p.sens, p.reac, p.disc, p.resp, p.sil, p.iron, 2); // Default Stab 2 for ref
            
            // Update UI
            updateAdvanced();
            updateExpert();
            updateSimulator();
        }

        // --- DEPRECATED OLD WIZARD FUNCTIONS (KEPT FOR COMPATIBILITY OR REMOVED) ---
        function updateWizard() {
            // No real-time updates now, waiting for button press
        }

        // --- CORE SIMULATION LOGIC (REFACTORED FOR REUSE) ---
        function calculatePerfFromValues(sens, reac, disc, audioResp, silencer, ironVol, stabilizer) {
             // Basic heuristics
             let depth = 50 + (sens - 90) * 2 - (reac * 5) + (audioResp * 2);
             if (stabilizer > 2) depth -= 5;
             
             let masking = 20 + (disc * 0.5) + (silencer * 5) - (reac * 8);
             if (ironVol === 0) masking += 10; 

             let separation = (reac / 5) * 100 + (disc > 5 ? 5 : 0);
             let finesse = ((sens - 70) / 29) * 100; // Simplified finesse based on sens
             let id = 80 - (sens > 95 ? (sens - 95) * 5 : 0) + (stabilizer * 5);

             return {
                depth: Math.max(0, Math.min(100, depth)),
                masking: Math.max(0, Math.min(100, masking)),
                separation: Math.max(0, Math.min(100, separation)),
                finesse: Math.max(0, Math.min(100, finesse)),
                id: Math.max(0, Math.min(100, id))
             };
        }

        function calculatePerformance() {
            let sens = parseFloat(document.getElementById('rng-sens').value);
            let reac = parseFloat(document.getElementById('rng-reac').value);
            
            // Expert Modifiers
            const processMode = document.getElementById('sel-process-mode').value;
            if (processMode !== 'standard') {
                const v1Reac = parseFloat(document.getElementById('rng-v1-reac').value);
                const v1Sens = parseFloat(document.getElementById('rng-v1-sens').value);
                const v2Reac = parseFloat(document.getElementById('rng-v2-reac').value);
                const v2Sens = parseFloat(document.getElementById('rng-v2-sens').value);

                if (processMode === 'fusion') {
                    sens = (sens + v1Sens + v2Sens) / 3; 
                    reac = (reac + v1Reac + v2Reac) / 3;
                } else if (processMode === 'depth') {
                    sens = (v1Sens * 0.7) + (sens * 0.3);
                    reac = (v1Reac * 0.7) + (reac * 0.3);
                } else if (processMode === 'sep') {
                    sens = (v2Sens * 0.6) + (sens * 0.4);
                    reac = (v2Reac * 0.8) + (reac * 0.2); 
                }
            }

            const disc = parseFloat(document.getElementById('rng-disc').value);
            const audioResp = parseFloat(document.getElementById('rng-resp').value);
            const silencer = parseFloat(document.getElementById('rng-sil').value);
            const ironVol = parseFloat(document.getElementById('rng-iron').value);
            const stabilizer = parseFloat(document.getElementById('rng-stab').value);

            let perf = calculatePerfFromValues(sens, reac, disc, audioResp, silencer, ironVol, stabilizer);

            // Additional FMF & Audio Tweaks (applied on top of base calculation)
            const fmf = document.getElementById('sel-fmf').value;
            if (fmf === 'sensitive') perf.finesse += 15;
            
            const audioType = document.getElementById('sel-audio').value;
            if (audioType === 'Morphing') {
                const mm = document.getElementById('sel-morphing-mode').value;
                if (mm == '1') { perf.depth += 5; perf.id -= 5; } 
                if (mm == '2') { perf.separation += 5; perf.depth -= 5; }
                if (mm == '3') { perf.depth += 10; perf.masking += 10; } 
                if (mm == '4') { perf.separation += 10; perf.id += 5; } 
            }

            // Cap again just in case modifiers pushed it over
            Object.keys(perf).forEach(key => perf[key] = Math.max(0, Math.min(100, perf[key])));
            
            return perf;
        }

        function updateSimulator() {
            const sens = parseFloat(document.getElementById('rng-sens').value);
            const reac = parseFloat(document.getElementById('rng-reac').value);
            const disc = parseFloat(document.getElementById('rng-disc').value);
            const sil = document.getElementById('rng-sil').value;
            const iron = document.getElementById('rng-iron').value;
            const bcaps = document.getElementById('rng-bcaps').value;
            const notch = document.getElementById('rng-notch').value;
            const audioType = document.getElementById('sel-audio').value;

            // Gestion Affichage Morphing
            const morphContainer = document.getElementById('morphing-config');
            if (audioType === 'Morphing') {
                morphContainer.style.display = 'block';
            } else {
                morphContainer.style.display = 'none';
            }

            document.getElementById('val-sens').textContent = sens;
            document.getElementById('val-reac').textContent = reac.toFixed(1);
            document.getElementById('val-disc').textContent = disc;
            document.getElementById('val-sil').textContent = sil;
            document.getElementById('val-iron').textContent = iron;
            document.getElementById('val-audio').textContent = audioType;
            document.getElementById('val-bcaps').textContent = bcaps;
            document.getElementById('val-notch').textContent = notch == 0 ? 'OFF' : notch + ' Hz';

            const perf = calculatePerformance();
            
            document.getElementById('bar-depth').style.width = perf.depth + '%';
            document.getElementById('bar-sep').style.width = perf.separation + '%';
            document.getElementById('bar-fine').style.width = perf.finesse + '%';
            document.getElementById('bar-id').style.width = perf.id + '%';
            document.getElementById('bar-mask').style.width = perf.masking + '%';

            // Feedbacks
            const feedSens = sens < 80 ? 'Faible' : sens < 90 ? 'Bon' : sens < 95 ? 'Agressif' : 'Tr√®s agressif';
            document.getElementById('feed-sens').textContent = feedSens + (sens > 96 ? ' ‚ö†Ô∏è Risque masquage' : '');
            document.getElementById('feed-sens').className = 'param-feedback ' + (sens > 96 ? 'feedback-warn' : 'feedback-good');

            const feedReac = reac === 0 ? 'Max puissance - Balayage tr√®s lent' : reac < 1.5 ? 'Profondeur max' : reac < 3 ? 'Bon √©quilibre' : 'Vitesse surface';
            document.getElementById('feed-reac').textContent = feedReac;

            const perte = disc * 1.2;
            document.getElementById('feed-disc').textContent = `Perte Or estim√©e: ~${perte.toFixed(1)}%`;
            document.getElementById('feed-disc').className = 'param-feedback ' + (perte > 20 ? 'feedback-warn' : 'feedback-good');

            // Morphing Feedback
            if (audioType === 'Morphing') {
                const mm = document.getElementById('sel-morphing-mode').value;
                const mTxt = mm==1?"Profondeur pure":mm==2?"Nettoyage audio":mm==3?"Boost ultra-finesse": "Polyvalent";
                document.getElementById('feed-morphing-sub').textContent = `Courbe active : ${mTxt}`;
            }

            document.getElementById('feed-sil').textContent = 'Silencer ' + (sil == 0 ? 'OFF' : '√† ' + sil);
            document.getElementById('feed-iron').textContent = 'Volume Fer ' + (iron == 0 ? 'MUET' : iron);
            document.getElementById('feed-bcaps').textContent = bcaps == 0 ? 'D√©sactiv√©' : 'Actif √† ' + bcaps;
            document.getElementById('feed-notch').textContent = notch == 0 ? 'Aucune fr√©quence rejet√©e' : 'Rejet √† ' + notch + ' Hz';

            const analysis = `<strong>üìä Indice Puissance:</strong> <strong style="color:var(--accent-gold);">${perf.depth.toFixed(0)}/100</strong><br/>
                <strong>Masquage:</strong> <strong>${perf.masking.toFixed(1)}%</strong> ${perf.masking > 60 ? '‚ö†Ô∏è Risque cibles manqu√©es' : '‚úÖ Acceptable'}<br/>
                <strong>S√©paration:</strong> <strong>${perf.separation.toFixed(1)}%</strong>`;
            document.getElementById('sim-analysis').innerHTML = analysis;

            updateRadarChart();
        }

        function updateExpert() {
            const v1Reac = parseFloat(document.getElementById('rng-v1-reac').value);
            const v1Sens = parseFloat(document.getElementById('rng-v1-sens').value);
            const v2Reac = parseFloat(document.getElementById('rng-v2-reac').value);
            const v2Sens = parseFloat(document.getElementById('rng-v2-sens').value);

            document.getElementById('val-v1-reac').textContent = v1Reac.toFixed(1);
            document.getElementById('val-v1-sens').textContent = v1Sens;
            document.getElementById('val-v2-reac').textContent = v2Reac.toFixed(1);
            document.getElementById('val-v2-sens').textContent = v2Sens;

            const v1Depth = 50 - (v1Reac * 3) - ((100 - v1Sens) * 0.1);
            const v2Sep = (v2Reac / 5) * 100;

            const gap = v2Reac - v1Reac;
            const coverage = gap > 2 ? '‚úÖ Couverture maximale' : gap > 1 ? '‚ö†Ô∏è Bon √©cart' : '‚ùå √âcart trop faible';

            document.getElementById('expert-feedback').innerHTML = `<strong>V1 Profondeur:</strong> ${v1Depth.toFixed(1)} (index) | <strong>V2 S√©paration:</strong> ${v2Sep.toFixed(1)}%<br/>
                <strong>√âcart r√©activit√©:</strong> ${gap.toFixed(1)} - ${coverage}`;
        }

        function updateAdvanced() {
            const stab = document.getElementById('rng-stab').value;
            const grab = document.getElementById('rng-grab').value;

            document.getElementById('val-stab').textContent = stab;
            document.getElementById('val-grab').textContent = grab == 0 ? 'AUTO' : grab + ' GB';

            const stabTxt = stab == 0 ? 'OFF (Risque faux signaux)' : stab == 1 ? 'L√©ger' : stab == 2 ? 'Standard' : 'Fort (Perte or fin)';
            document.getElementById('feed-stab').textContent = stabTxt;
            document.getElementById('feed-grab').textContent = grab == 0 ? 'Mode AUTO (scan permanent)' : `GB Manuel: ${grab}`;

            const analysis = `<strong>üéõÔ∏è Tuning Avanc√©:</strong> Stabilizer ${stabTxt} | Ground Grab ${grab == 0 ? 'AUTO' : grab}`;
            
            // Correction de l'erreur: s'assurer que l'√©l√©ment existe avant d'√©crire
            const feedbackEl = document.getElementById('advanced-feedback');
            if (feedbackEl) {
                feedbackEl.innerHTML = analysis;
            }
        }

        function initRadarChart() {
            const ctx = document.getElementById('radarChart');
            if (!ctx) return;
            
            if (radarChart) {
                radarChart.destroy();
            }

            radarChart = new Chart(ctx, {
                type: 'radar',
                data: { 
                    labels: ['Puissance', 'S√©paration', 'Finesse', 'ID (Stabilit√©)', 'Z√©ro Masquage'], 
                    datasets: [
                        { 
                            label: 'Performance Actuelle', 
                            data: [50, 50, 50, 50, 50],
                            borderColor: '#d4af37', 
                            backgroundColor: 'rgba(212, 175, 55, 0.15)', 
                            borderWidth: 2, 
                            pointBackgroundColor: '#d4af37',
                            fill: true,
                            order: 1
                        },
                        {
                            label: 'R√©f√©rence (Usine)',
                            data: [50, 50, 50, 50, 50], // Will be updated by loadProgram
                            borderColor: '#a0a0a0',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointBackgroundColor: 'transparent',
                            pointBorderColor: 'transparent',
                            order: 2
                        }
                    ] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, /* Legend is custom in HTML for mobile control */
                    scales: { 
                        r: { 
                            beginAtZero: true, 
                            max: 100, 
                            grid: { color: '#2d333d' }, 
                            ticks: { display: false },
                            pointLabels: {
                                font: { size: 10 } /* Smaller labels for mobile */
                            }
                        } 
                    } 
                }
            });
            updateRadarChart();
        }

        function updateRadarChart() {
            if (!radarChart) return;
            
            // Update Current Performance
            const perf = calculatePerformance();
            radarChart.data.datasets[0].data = [perf.depth, perf.separation, perf.finesse, perf.id, 100 - perf.masking];
            
            // Update Reference (if exists)
            if (referenceStats) {
                radarChart.data.datasets[1].data = [referenceStats.depth, referenceStats.separation, referenceStats.finesse, referenceStats.id, 100 - referenceStats.masking];
            }

            radarChart.update();
        }

        function loadFAQ() {
            const container = document.getElementById('faq-container');
            container.innerHTML = DATA.faq.map(item => `<div class="faq-item">
                <strong>Q: ${item.q}</strong>
                <p style="margin-top:10px; color:var(--text-main);">R: ${item.r}</p>
            </div>`).join('');
        }

        function saveProfile() {
            const name = document.getElementById('profile-name').value.trim();
            if (!name) { alert('‚ùå Nom requis'); return; }
            const profile = {
                name: name,
                terrain: document.getElementById('profile-terrain').value,
                sens: parseFloat(document.getElementById('rng-sens').value),
                reac: parseFloat(document.getElementById('rng-reac').value),
                disc: parseFloat(document.getElementById('rng-disc').value),
                sil: parseFloat(document.getElementById('rng-sil').value),
                bcaps: parseFloat(document.getElementById('rng-bcaps').value),
                notch: parseFloat(document.getElementById('rng-notch').value),
                fmf: document.getElementById('sel-fmf').value,
                audio: document.getElementById('sel-audio').value,
                resp: parseFloat(document.getElementById('rng-resp').value),
                iron: parseFloat(document.getElementById('rng-iron').value),
                v1reac: parseFloat(document.getElementById('rng-v1-reac').value),
                v1sens: parseFloat(document.getElementById('rng-v1-sens').value),
                v2reac: parseFloat(document.getElementById('rng-v2-reac').value),
                v2sens: parseFloat(document.getElementById('rng-v2-sens').value),
                stab: parseFloat(document.getElementById('rng-stab').value),
                grab: parseFloat(document.getElementById('rng-grab').value),
                timestamp: new Date().toLocaleString('fr-FR')
            };
            let profiles = JSON.parse(localStorage.getItem('xpProfiles') || '[]');
            profiles.push(profile);
            localStorage.setItem('xpProfiles', JSON.stringify(profiles));
            alert('‚úÖ Profil sauvegard√©!');
            document.getElementById('profile-name').value = '';
            document.getElementById('profile-terrain').value = '';
            loadProfilesList();
        }

        function loadProfilesList() {
            const profiles = JSON.parse(localStorage.getItem('xpProfiles') || '[]');
            const list = document.getElementById('saved-profiles-list');
            if (profiles.length === 0) { list.innerHTML = '<p style="color:var(--text-dim); text-align:center;">Aucun profil.</p>'; return; }
            list.innerHTML = profiles.map((p, i) => `
                <div class="saved-item">
                    <div style="flex:1;">
                        <h4>${p.name}</h4>
                        <p>${p.terrain || 'N/A'} | S:${p.sens} R:${p.reac} D:${p.disc}</p>
                        <p style="font-size:0.75rem; color:var(--text-dim);">${p.timestamp}</p>
                    </div>
                    <div class="saved-item-actions">
                        <button class="btn-download" onclick="loadProfile(${i})">üì• Charger</button>
                        <button class="btn-delete" onclick="deleteProfile(${i})">üóëÔ∏è Suppr</button>
                    </div>
                </div>
            `).join('');
        }

        function loadProfile(idx) {
            const profiles = JSON.parse(localStorage.getItem('xpProfiles') || '[]');
            const p = profiles[idx];
            if(!p) return;
            document.getElementById('rng-sens').value = p.sens;
            document.getElementById('rng-reac').value = p.reac;
            document.getElementById('rng-disc').value = p.disc;
            document.getElementById('rng-sil').value = p.sil || 1;
            document.getElementById('rng-bcaps').value = p.bcaps || 0;
            document.getElementById('rng-notch').value = p.notch || 0;
            document.getElementById('sel-fmf').value = p.fmf || 'general';
            document.getElementById('sel-audio').value = p.audio || 'Square';
            document.getElementById('rng-resp').value = p.resp || 4;
            document.getElementById('rng-iron').value = p.iron || 3;
            document.getElementById('rng-v1-reac').value = p.v1reac || 1;
            document.getElementById('rng-v1-sens').value = p.v1sens || 95;
            document.getElementById('rng-v2-reac').value = p.v2reac || 3.5;
            document.getElementById('rng-v2-sens').value = p.v2sens || 90;
            document.getElementById('rng-stab').value = p.stab || 2;
            document.getElementById('rng-grab').value = p.grab || 0;
            
            // Expert Mode Load
            if (p.processMode) document.getElementById('sel-process-mode').value = p.processMode;

            setTab('config');
            updateSimulator();
            alert('‚úÖ Profil charg√©!');
        }

        function deleteProfile(idx) {
            if (!confirm('Supprimer ce profil?')) return;
            let profiles = JSON.parse(localStorage.getItem('xpProfiles') || '[]');
            profiles.splice(idx, 1);
            localStorage.setItem('xpProfiles', JSON.stringify(profiles));
            loadProfilesList();
        }

        function addLog() {
            const find = document.getElementById('log-find').value.trim();
            const depth = document.getElementById('log-depth').value;
            if (!find) { alert('Trouvaille requise'); return; }
            let logs = JSON.parse(localStorage.getItem('xpLogs') || '[]');
            logs.push({ find, depth, date: new Date().toLocaleString('fr-FR') });
            localStorage.setItem('xpLogs', JSON.stringify(logs));
            document.getElementById('log-find').value = '';
            document.getElementById('log-depth').value = '';
            loadLogbook();
        }

        function loadLogbook() {
            const logs = JSON.parse(localStorage.getItem('xpLogs') || '[]');
            const list = document.getElementById('logbook-list');
            if (logs.length === 0) { list.innerHTML = '<p style="color:var(--text-dim);">Journal vide.</p>'; return; }
            list.innerHTML = logs.reverse().map(l => `<div class="saved-item">
                <p><strong>${l.find}</strong> - ${l.depth || 'N/A'}cm | ${l.date}</p>
            </div>`).join('');
        }
    </script>
</body>
</html>
